# docker-compose.yml
#
# Runs the full VaultTabs stack with one command:
#   docker compose up
#
# Services:
#   postgres  → Database (port 5432)
#   backend   → Fastify API (port 3000)
#   pwa       → Next.js PWA (port 3001)
#
# Production mode:
#   docker compose -f docker-compose.yml -f docker-compose.prod.yml up
#
# First-time setup:
#   1. Copy .env.example to .env and fill in values
#   2. docker compose up
#   3. docker compose exec backend npm run db:migrate

version: '3.9'

services:

  # ── PostgreSQL ──────────────────────────────────────────────────────────────
  postgres:
    image: postgres:16-alpine
    container_name: vaulttabs-postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB:       vaulttabs
      POSTGRES_USER:     vaulttabs
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-localdevpassword}
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      # Run init SQL on first startup
      - ./docker/postgres-init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    healthcheck:
      test: CMD-SHELL pg_isready -U vaulttabs -d vaulttabs
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 10s

  # ── Backend (Fastify) ───────────────────────────────────────────────────────
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: vaulttabs-backend
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      NODE_ENV:     development
      PORT:         3000
      DATABASE_URL: postgres://vaulttabs:${POSTGRES_PASSWORD:-localdevpassword}@postgres:5432/vaulttabs
      JWT_SECRET:   "${JWT_SECRET:?JWT_SECRET is required - run: node -e \"console.log(require('crypto').randomBytes(32).toString('hex'))\"}"
      JWT_EXPIRY:   ${JWT_EXPIRY:-30d}
      ALLOWED_ORIGINS: ${ALLOWED_ORIGINS:-http://localhost:3001}
    ports:
      - "3000:3000"
    volumes:
      # Hot reload in dev: mount source, not just the build
      - ./backend/src:/app/src:ro
    healthcheck:
      test: CMD-SHELL wget -qO- http://localhost:3000/health || exit 1
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s

  # ── PWA (Next.js) ───────────────────────────────────────────────────────────
  pwa:
    build:
      context: ./pwa
      dockerfile: Dockerfile
    container_name: vaulttabs-pwa
    restart: unless-stopped
    depends_on:
      backend:
        condition: service_healthy
    environment:
      NODE_ENV:               production
      NEXT_PUBLIC_API_URL:    ${NEXT_PUBLIC_API_URL:-http://localhost:3000/api/v1}
    ports:
      - "3001:3001"
    healthcheck:
      test: CMD-SHELL wget -qO- http://localhost:3001 || exit 1
      interval: 15s
      timeout: 5s
      retries: 5
      start_period: 30s

  # ── Cleanup job (runs every hour) ──────────────────────────────────────────
  # Expires old restore_requests and enforces snapshot retention limits.
  # Uses the same backend image — just runs a different command.
  cleanup:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: vaulttabs-cleanup
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      DATABASE_URL: postgres://vaulttabs:${POSTGRES_PASSWORD:-localdevpassword}@postgres:5432/vaulttabs
    command: ["sh", "-c", "while true; do node dist/db/cleanup.js; sleep 3600; done"]

volumes:
  postgres_data:
    driver: local